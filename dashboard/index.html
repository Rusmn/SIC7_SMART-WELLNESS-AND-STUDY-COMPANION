<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SWSC – Study Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="style.css" rel="stylesheet" />
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-item">Temp: <span id="nav-temp">{{ temp }}</span> °C</div>
      <div class="nav-item">Humidity: <span id="nav-hum">{{ hum }}</span> %</div>
      <div class="nav-item">Light: <span id="nav-light">{{ light }}</span></div>
      <div class="nav-item">Status: <span id="nav-status">{{ status }}</span></div>
    </nav>

    <main class="page">
      <section class="tabs">
        <button class="tab-btn active" data-tab="tab-countdown">Countdown</button>
        <button class="tab-btn" data-tab="tab-water">Ceklis Air</button>
        <button class="tab-btn" data-tab="tab-monitor">Monitoring</button>
        <button class="tab-btn" data-tab="tab-debug" id="debug-tab-button">Debug</button>
      </section>

      <section id="tab-countdown" class="panel tab active">
        <div class="planner">
          <label for="durationInput">Total Study Duration (minutes)</label>
          <div class="planner-row">
            <input id="durationInput" type="number" min="1" value="60" />
            <button id="btn-calc" class="btn">Calculate</button>
          </div>
          <div class="plan-summary" id="planSummary">
            <div>Break interval: <b id="plan-interval">-</b> min</div>
            <div>Total breaks: <b id="plan-count">-</b> times</div>
            <div>Each break: <b id="plan-length">-</b> min</div>
            <div>Water milestones: <b id="plan-water-count">-</b> times</div>
            <div>Water per milestone: <b id="plan-water-per">-</b> ml</div>
            <div>Total water: <b id="plan-water-total">-</b> ml</div>
          </div>
        </div>

        <div class="display">
          <div class="display-title" id="phase-label">SESSION</div>
          <div class="display-time" id="phase-time">00:00</div>
          <div class="sub-display">
            <span class="sub-label">Total remaining</span>
            <span class="sub-time" id="total-time">00:00</span>
          </div>
          <div class="display-actions">
            <button id="btn-start" class="btn">Start</button>
            <button id="btn-stop" class="btn btn-secondary">Stop</button>
            <button id="btn-reset" class="btn btn-secondary">Reset</button>
          </div>
        </div>
      </section>

      <section id="tab-water" class="panel tab">
        <div class="water-list" id="water-list">
          <div class="hint">
            Belum ada plan. Hitung dulu di tab Countdown, lalu tekan Start.
          </div>
        </div>
      </section>

      <section id="tab-monitor" class="panel tab">
        <div class="monitor-grid">
          <div class="monitor-card">
            <div class="monitor-title">Temperature</div>
            <div class="monitor-value"><span id="mon-temp">{{ temp }}</span> °C</div>
          </div>
          <div class="monitor-card">
            <div class="monitor-title">Humidity</div>
            <div class="monitor-value"><span id="mon-hum">{{ hum }}</span> %</div>
          </div>
          <div class="monitor-card">
            <div class="monitor-title">Light</div>
            <div class="monitor-value"><span id="mon-light">{{ light }}</span></div>
          </div>
        </div>
        <div class="monitor-summary-card" id="mon-summary-card">
          <div class="monitor-title">Kesimpulan Kondisi</div>
          <div class="monitor-value" id="mon-summary-text">Memuat...</div>
        </div>
        <div class="muted">Data diperbarui setiap ±2 detik atau saat ada pesan IoT.</div>
      </section>

      <section id="tab-debug" class="panel tab">
        <div class="debug-panel">
          <h3>Panel Debug ESP32</h3>
          <p class="hint">
            Tombol ini mengirim pesan MQTT palsu untuk menguji
            reaksi hardware (LED & Buzzer) secara instan.
          </p>
          
          <div class="debug-group">
            <h4>Tes Sesi</h4>
            <button id="dbg-session-stop" class="btn btn-debug">Tes: Sesi Selesai (Stop)</button>
            <button id="dbg-session-reset" class="btn btn-debug">Tes: Reset</button>
          </div>

          <div class="debug-group">
            <h4>Tes Istirahat (Break)</h4>
            <button id="dbg-break-start" class="btn btn-debug">Tes: Mulai Istirahat</button>
            <button id="dbg-break-end" class="btn btn-debug">Tes: Akhir Istirahat</button>
          </div>

          <div class="debug-group">
            <h4>Tes Air (Water Alert)</h4>
            <button id="dbg-water-start" class="btn btn-debug">Tes: Water Alert (ID 0)</button>
            <button id="dbg-water-stop" class="btn btn-debug">Tes: Water Acknowledge (ID 0)</button>
          </div>

          <div class="debug-group">
            <h4>Tes Sesi</h4>
            <button id="dbg-session-start-test" class="btn btn-debug btn-debug-start">
              Tes: Mulai Sesi Tes 5 Menit
            </button>
            <button id="dbg-session-stop" class="btn btn-debug">Tes: Sesi Selesai (Stop)</button>
            <button id="dbg-session-reset" class="btn btn-debug">Tes: Reset</button>
          </div>
        </div>
      </section>
    </main>

    <script>
      const DEBUG_MODE = false; 

      if (!DEBUG_MODE) {
        const btn = document.getElementById("debug-tab-button");
        const panel = document.getElementById("tab-debug");
        if (btn) btn.style.display = "none";
        if (panel) panel.style.display = "none";
      }

      function pad(n) {
        return n < 10 ? "0" + n : n;
      }
      function asClock(sec) {
        const m = Math.floor(sec / 60),
          s = sec % 60;
        return `${pad(m)}:${pad(s)}`;
      }

      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.onclick = () => {
          document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
          document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(btn.dataset.tab).classList.add("active");
        };
      });

      async function calcPlan() {
        const duration = Math.max(1, parseInt(document.getElementById("durationInput").value || "0", 10));
        const r = await fetch("/plan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ duration_min: duration }),
        });
        const p = await r.json();
        document.getElementById("plan-interval").textContent = p.break_interval_min;
        document.getElementById("plan-count").textContent = p.break_count;
        document.getElementById("plan-length").textContent = p.break_length_min;
        document.getElementById("plan-water-count").textContent = p.water_milestones.length;
        document.getElementById("plan-water-per").textContent = p.water_amount_ml_per;
        document.getElementById("plan-water-total").textContent = p.water_total_ml;
        renderWaterList(p.water_milestones, p.water_amount_ml_per);
        return p;
      }
      document.getElementById("btn-calc").onclick = calcPlan;

      document.getElementById("btn-start").onclick = async () => {
        const duration = Math.max(1, parseInt(document.getElementById("durationInput").value || "0", 10));
        await fetch("/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ duration_min: duration }),
        });
        await calcPlan();
      };
      document.getElementById("btn-stop").onclick = async () => {
        await fetch("/stop", { method: "POST" });
      };
      document.getElementById("btn-reset").onclick = async () => {
        await fetch("/reset", { method: "POST" });
        renderWaterList([], 0);
      };

      async function refreshState() {
        try {
          const r = await fetch("/state");
          const s = await r.json();
          document.getElementById("phase-label").textContent = s.phase.toUpperCase();
          document.getElementById("phase-time").textContent = asClock(s.phase_remaining_sec);
          document.getElementById("total-time").textContent = asClock(s.total_remaining_sec);
          updateWaterActive(s.water_active || {});
        } catch (_) {}
      }
      setInterval(refreshState, 1000);

      async function refreshStatus() {
        try {
          const r = await fetch("/status");
          const d = await r.json();
          const lightText = d.light === "0.0" ? "Gelap" : "Terang";
          document.getElementById("nav-temp").textContent = d.temperature;
          document.getElementById("nav-hum").textContent = d.humidity;
          document.getElementById("nav-light").textContent = lightText;
          document.getElementById("nav-status").textContent = d.system_status;

          document.getElementById("mon-temp").textContent = d.temperature;
          document.getElementById("mon-hum").textContent = d.humidity;
          document.getElementById("mon-light").textContent = lightText;

          const summaryCard = document.getElementById("mon-summary-card");
          const summaryText = document.getElementById("mon-summary-text");
          const navbar = document.querySelector(".navbar");
          
          if (d.alert_level === "bad") {
            navbar.style.background = "rgba(200,0,0,0.6)";
            navbar.style.backdropFilter = "blur(4px)";
            summaryText.textContent = "Tidak Ideal";
            summaryCard.className = "monitor-summary-card bad";
          } else if (d.alert_level === "good") {
            navbar.style.background = "rgba(0,128,0,0.4)";
            summaryText.textContent = "Ideal";
            summaryCard.className = "monitor-summary-card good";
          } else {
            navbar.style.background = "rgba(255,255,255,0.15)";
            summaryText.textContent = "Data Tidak Ada";
            summaryCard.className = "monitor-summary-card unknown";
          }
        } catch (_) {}
      }
      setInterval(refreshStatus, 2000);
      refreshStatus();

      function renderWaterList(milestones, per_ml) {
        const host = document.getElementById("water-list");
        if (!milestones || milestones.length === 0) {
          host.innerHTML = '<div class="hint">Tidak ada milestone minum. Hitung plan lalu mulai.</div>';
          return;
        }
        const items = milestones.map((sec, idx) => {
          const t = asClock(sec);
          return `
          <div class="water-item" data-id="${idx}">
            <div class="water-left">
              <div class="water-title">Milestone ${idx + 1}</div>
              <div class="water-time">At ${t}</div>
            </div>
            <div class="water-right">
              <div class="water-ml">${per_ml} ml</div>
              <label class="water-check">
                <input type="checkbox" data-check="${idx}"> Done
              </label>
            </div>
          </div>`;
        }).join("");
        host.innerHTML = items;
        host.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
          cb.onchange = async (e) => {
            const id = parseInt(e.target.getAttribute("data-check"), 10);
            if (e.target.checked) {
              await fetch("/water_ack", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ milestone_id: id }),
              });
            }
          };
        });
      }

      function updateWaterActive(map) {
        const host = document.getElementById("water-list");
        host.querySelectorAll(".water-item").forEach((el) => {
          const id = parseInt(el.getAttribute("data-id"), 10);
          const active = !!map[id];
          el.classList.toggle("active", active);
        });
      }

      async function startTestSession() {
        try {
          const r = await fetch("/debug/start_test", { method: "POST" });
          const data = await r.json();
          
          if (data.plan) {
            const p = data.plan;
            document.getElementById("plan-interval").textContent = p.break_interval_min;
            document.getElementById("plan-count").textContent = p.break_count;
            document.getElementById("plan-length").textContent = p.break_length_min;
            document.getElementById("plan-water-count").textContent = p.water_milestones.length;
            document.getElementById("plan-water-per").textContent = p.water_amount_ml_per;
            document.getElementById("plan-water-total").textContent = p.water_total_ml;
            renderWaterList(p.water_milestones, p.water_amount_ml_per);
            document.querySelector('[data-tab="tab-countdown"]').click();
          }
        } catch (e) {
          console.error("Start test session failed", e);
        }
      }
      
      async function triggerDebug(event, payload = "") {
        try {
          await fetch("/debug/trigger", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ event: event, payload: payload }),
          });
        } catch (e) {
          console.error("Debug trigger failed", e);
        }
      }
      
      if (DEBUG_MODE) {
        document.getElementById("dbg-session-start-test").onclick = startTestSession;
        document.getElementById("dbg-session-stop").onclick = () => triggerDebug("force_stop");
        document.getElementById("dbg-session-reset").onclick = () => triggerDebug("force_reset");
        
        document.getElementById("dbg-break-start").onclick = () => triggerDebug("break_start");
        document.getElementById("dbg-break-end").onclick = () => triggerDebug("break_end");

        document.getElementById("dbg-water-start").onclick = () => triggerDebug("water_start", "0");
        document.getElementById("dbg-water-stop").onclick = () => triggerDebug("water_stop", "0");
      }
    </script>
  </body>
</html>